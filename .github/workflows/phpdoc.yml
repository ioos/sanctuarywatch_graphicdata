name: Generate API Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/graphic_data_plugin/**'
      - '.github/workflows/phpdoc.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure output directory
        run: |
          mkdir -p docs/function_documentation

      - name: Generate HTML documentation with phpDocumentor
        run: |
          docker run --rm -v "${PWD}":/data phpdoc/phpdoc:3 \
            -d /data/plugins/graphic_data_plugin \
            -t /data/docs/function_documentation \
            --ignore "admin/exopite-simple-options/*" || true

      - name: Fix file permissions after Docker
        run: |
          if [ -d docs/function_documentation ]; then
            sudo chown -R $(id -u):$(id -g) docs/function_documentation
          fi

      - name: Convert phpDocumentor HTML to Jekyll pages
        run: |
          if [ -d docs/function_documentation ]; then
            python3 .github/scripts/convert_phpdoc_to_jekyll.py docs/function_documentation || true
          else
            echo "No phpDocumentor output found at docs/function_documentation"
          fi

      - name: Add Jekyll front matter to generated pages
        run: |
          if [ -f docs/function_documentation/index.md ]; then
            printf '%s\n' '---' 'layout: page' 'title: Function Documentation' 'permalink: /function_documentation/' '---' > docs/function_documentation/index_temp.md
            cat docs/function_documentation/index.md >> docs/function_documentation/index_temp.md
            mv docs/function_documentation/index_temp.md docs/function_documentation/index.md
          fi

          if [ -f docs/function_documentation/api-reference.md ]; then
            printf '%s\n' '---' 'layout: page' 'title: Full API Reference' 'permalink: /function_documentation/reference/' '---' > docs/function_documentation/api-reference_temp.md
            cat docs/function_documentation/api-reference.md >> docs/function_documentation/api-reference_temp.md
            mv docs/function_documentation/api-reference_temp.md docs/function_documentation/api-reference.md
          fi

      - name: Update navigation in docs/_config.yml
        run: |
          if ! grep -q "function_documentation/index.md" docs/_config.yml; then
            sed -i "/^# Exclude files from processing/i\  - function_documentation/index.md" docs/_config.yml || true
          fi

      - name: Commit and push generated docs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/function_documentation/ || true
          git add docs/_config.yml || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Update function documentation [skip ci]"
            git push
          fi