name: Generate API Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/graphic_data_plugin/**'
      - '.github/workflows/phpdoc.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Install phpdoc-md
        run: |
          composer require --no-interaction --dev clean/phpdoc-md:^0.19

      - name: Ensure output directory
        run: |
          mkdir -p docs/function_documentation

      - name: Generate markdown documentation with phpdoc-md
        run: |
          # Generate markdown directly into docs/function_documentation
          vendor/bin/phpdoc-md generate plugins/graphic_data_plugin \
            --format github \
            --output docs/function_documentation/api-reference.md \
            --index docs/function_documentation/index.md || true

      - name: Add Jekyll front matter to generated pages
        run: |
          if [ -f docs/function_documentation/index.md ]; then
            printf '%s
' '---' 'layout: page' 'title: Function Documentation' 'permalink: /function_documentation/' '---' > docs/function_documentation/index_temp.md
            cat docs/function_documentation/index.md >> docs/function_documentation/index_temp.md
            mv docs/function_documentation/index_temp.md docs/function_documentation/index.md
          fi

          if [ -f docs/function_documentation/api-reference.md ]; then
            printf '%s
' '---' 'layout: page' 'title: Full API Reference' 'permalink: /function_documentation/reference/' '---' > docs/function_documentation/api-reference_temp.md
            cat docs/function_documentation/api-reference.md >> docs/function_documentation/api-reference_temp.md
            mv docs/function_documentation/api-reference_temp.md docs/function_documentation/api-reference.md
          fi

      - name: Update navigation in docs/_config.yml
        run: |
          # Add function_documentation index to header_pages if missing
          if ! grep -q "function_documentation/index.md" docs/_config.yml; then
            sed -i "/^# Exclude files from processing/i\  - function_documentation/index.md" docs/_config.yml || true
          fi

      - name: Commit and push generated docs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/function_documentation/ || true
          git add docs/_config.yml || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Update function documentation [skip ci]"
            git push
          fi