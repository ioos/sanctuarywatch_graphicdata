name: Generate API Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/graphic_data_plugin/**'
      - '.github/workflows/phpdoc.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Install phpDocumentor
        run: |
          composer require --no-interaction --dev phpdocumentor/phpdocumentor:^3.2

      - name: Ensure output directory
        run: |
          mkdir -p docs/function_documentation

      - name: Generate HTML documentation with phpDocumentor
        run: |
          # Generate HTML documentation into docs/function_documentation
          vendor/bin/phpdoc -d plugins/graphic_data_plugin -t docs/function_documentation || true

      - name: Convert phpDocumentor HTML to Jekyll pages
        run: |
          # Convert the generated HTML files into Jekyll pages by extracting
          # the <body> and prepending front matter so the site's layout is used.
          if [ -d docs/function_documentation ]; then
            python3 .github/scripts/convert_phpdoc_to_jekyll.py docs/function_documentation || true
          else
            echo "No phpDocumentor output found at docs/function_documentation"
          fi

      - name: Add Jekyll front matter to generated pages
        run: |
          if [ -f docs/function_documentation/index.md ]; then
            printf '%s\\n' '---' 'layout: page' 'title: Function Documentation' 'permalink: /function_documentation/' '---' > docs/function_documentation/index_temp.md
            cat docs/function_documentation/index.md >> docs/function_documentation/index_temp.md
            mv docs/function_documentation/index_temp.md docs/function_documentation/index.md
          fi

          if [ -f docs/function_documentation/api-reference.md ]; then
            printf '%s\\n' '---' 'layout: page' 'title: Full API Reference' 'permalink: /function_documentation/reference/' '---' > docs/function_documentation/api-reference_temp.md
            cat docs/function_documentation/api-reference.md >> docs/function_documentation/api-reference_temp.md
            mv docs/function_documentation/api-reference_temp.md docs/function_documentation/api-reference.md
          fi

      - name: Update navigation in docs/_config.yml
        run: |
          # Add function_documentation index to header_pages if missing
          if ! grep -q "function_documentation/index.md" docs/_config.yml; then
            sed -i "/^# Exclude files from processing/i\  - function_documentation/index.md" docs/_config.yml || true
          fi

      - name: Commit and push generated docs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/function_documentation/ || true
          git add docs/_config.yml || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Update function documentation [skip ci]"
            git push
          fi